<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>SecondBrain</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
</head>
<body>

<nav class="navbar bg-info" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">SecondBrain</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="offset-lg-3 col-lg-6 col-sm-12">
            <form onsubmit="handleSubmit(event)">
                <div class="mb-3 mt-3">
                    <label class="form-label" for="githubToken">GitHub Token</label>
                    <input aria-describedby="githubTokenHelp" class="form-control" id="githubToken" type="password">
                    <div class="form-text" id="githubTokenHelp">Create a Personal Access Token using the instructions <a
                            href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens">here</a>.
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="prompt">Prompt</label>
                    <textarea aria-describedby="promptHelp" class="form-control" id="prompt" rows="10"></textarea>
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary" type="submit">Submit</button>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="response">Response</label>
                    <textarea aria-describedby="responseHelp" class="form-control" id="response" readonly
                              rows="10"></textarea>
                </div>
            </form>
        </div>
    </div>
</div>

<script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.getElementById('prompt').value = stripLineBreaks(
        stripLeadingWhitespace(
            `Given the diffs from owner \"mcasperson\" and repo \"SecondBrain\" on branch \"main\",
            generate release notes with an introductory paragraph and then bullet points of significant changes.
            Use plain language.
            You will be penalized for offering code suggestions.
            You will be penalized for sounding excited about the changes.`))

    function stripLeadingWhitespace(text) {
        return text.split("\n").map(l => l.replace(/^\s+/g, '')).join("\n");
    }

    function stripLineBreaks(text) {
        return text.replace(/\n/g, ' ');
    }

    function handleSubmit(event) {
        event.preventDefault();

        disableForm()

        response.value = 'Loading...'

        const githubToken = document.getElementById('githubToken').value;
        const prompt = document.getElementById('prompt').value;

        fetch('/api/prompt?prompt=' + encodeURIComponent(prompt), {
            method: 'GET',
            headers: {
                'context': JSON.stringify({"GITHUB_TOKEN": githubToken}),
            }
        })
            .then(response => response.text())
            .then(data => {
                response.value = data
            })
            .catch((error) => {
                response.value = error
            })
            .finally(() => {
                enableForm()
            });
    }

    function disableForm() {
        document.getElementById('githubToken').disabled = true;
        document.getElementById('prompt').disabled = true;
        document.querySelector('button').disabled = true;
    }

    function enableForm() {
        document.getElementById('githubToken').disabled = false;
        document.getElementById('prompt').disabled = false;
        document.querySelector('button').disabled = false;
    }
</script>
</body>
</html>
